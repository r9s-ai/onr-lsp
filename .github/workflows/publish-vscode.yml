name: Publish VSCode Extension

on:
  push:
    branches:
      - main
    paths:
      - "vscode/**"
      - ".github/workflows/publish-vscode.yml"

permissions:
  contents: write

jobs:
  test-and-publish:
    runs-on: ubuntu-latest
    env:
      GOWORK: off
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run Go tests
        run: go test ./...

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: vscode/package-lock.json

      - name: Build bundled onr-lsp binaries
        run: |
          set -euo pipefail
          EXT_VERSION="$(node -p "require('./vscode/package.json').version")"
          COMMIT="$(git rev-parse --short HEAD)"
          BUILD_DATE="$(date -u '+%Y-%m-%dT%H:%M:%SZ')"
          LDFLAGS="-s -w -X main.Version=${EXT_VERSION} -X main.Commit=${COMMIT} -X main.BuildDate=${BUILD_DATE}"

          rm -rf vscode/bin
          mkdir -p vscode/bin

          build_target() {
            local goos="$1"
            local goarch="$2"
            local outdir="$3"
            local exe="$4"
            mkdir -p "${outdir}"
            CGO_ENABLED=0 GOOS="${goos}" GOARCH="${goarch}" go build -trimpath -ldflags "${LDFLAGS}" -o "${outdir}/${exe}" ./cmd/onr-lsp
          }

          build_target linux amd64 "vscode/bin/linux-x64" "onr-lsp"
          build_target linux arm64 "vscode/bin/linux-arm64" "onr-lsp"
          build_target darwin amd64 "vscode/bin/darwin-x64" "onr-lsp"
          build_target darwin arm64 "vscode/bin/darwin-arm64" "onr-lsp"
          build_target windows amd64 "vscode/bin/win32-x64" "onr-lsp.exe"
          build_target windows arm64 "vscode/bin/win32-arm64" "onr-lsp.exe"

      - name: Install extension dependencies
        working-directory: vscode
        run: npm ci

      - name: Compile extension
        working-directory: vscode
        run: npm run compile

      - name: Prepare release metadata
        id: release
        run: |
          VERSION="$(node -p "require('./vscode/package.json').version")"
          VSIX_FILE="onr-lsp-${VERSION}.vsix"
          TAG_NAME="onr-lsp-v${VERSION}"
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "vsix_file=${VSIX_FILE}" >> "${GITHUB_OUTPUT}"
          echo "tag_name=${TAG_NAME}" >> "${GITHUB_OUTPUT}"

      - name: Package extension
        working-directory: vscode
        run: npx vsce package --out "${{ steps.release.outputs.vsix_file }}"

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release.outputs.tag_name }}
          name: onr-lsp ${{ steps.release.outputs.version }}
          target_commitish: ${{ github.sha }}
          generate_release_notes: true
          files: vscode/${{ steps.release.outputs.vsix_file }}

      - name: Publish extension to Marketplace
        if: ${{ secrets.VSCE_PAT != '' }}
        working-directory: vscode
        run: npx vsce publish -p "${VSCE_PAT}"
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Skip Marketplace publish without VSCE_PAT
        if: ${{ secrets.VSCE_PAT == '' }}
        run: echo "VSCE_PAT is not configured. Marketplace publish skipped."
